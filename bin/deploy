#!/bin/bash
set -e

DATABASE_FLAG=true

# 環境設定ファイルのコピー
cp services/api/env.template services/api/.env

# Dockerネットワークを作成
docker network ls | grep -wq school_app || docker network create school_app

# PostgreSQLデータベースコンテナを起動
if docker ps -a --format '{{.Names}}' | grep -wq postgres_db; then
    docker start postgres_db || true
else
    docker-compose -f docker-compose.db.yml up -d
fi

# データベースの存在を確認し、なければ作成
docker exec postgres_db psql -U postgres -lqt | cut -d \| -f 1 | grep -qw school_db
if [ $? -eq 1 ]; then
    docker exec postgres_db psql -U postgres -c "CREATE DATABASE school_db;"
fi

# メインのDocker Composeファイルを使ってサービスを起動
docker-compose up -d

DOCKER_BASE_FILE=docker-compose.yml
DOCKER_DATABASE_FILE=docker-compose.db.yml
DOCKER_NGINX_FILE=docker-compose.nginx.yml
DOCKER_FILE=""

if [ "$DATABASE_FLAG" = true ]; then
    DOCKER_FILE="-f $DOCKER_BASE_FILE -f $DOCKER_DATABASE_FILE -f $DOCKER_NGINX_FILE"
else
    DOCKER_FILE="-f $DOCKER_BASE_FILE -f $DOCKER_NGINX_FILE"
fi

# サービスを起動
docker-compose $DOCKER_FILE up -d

# デプロイ処理
docker-compose exec api bin/deploy
